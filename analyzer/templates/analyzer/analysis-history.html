{% extends "base.html" %}

{% block content %}
<div class="analyses-page">


  <header class="page-header mb-4">
    <h1 class="text-center fw-bold mb-0">Analysis History</h1>
  </header>

  {% if analyses %}
    <div class="container-narrow">

      <div class="row g-4">
        {% for a in analyses %}

          {% ifchanged a.created_at|date:"F Y" %}
            <div class="col-12">
              <div class="month-header">
                <div class="month-inner">
                  <span class="month-title">{{ a.created_at|date:"F Y" }}</span>
                  {% if forloop.first %}
                    <span class="month-count small">{{ analyses|length }} total</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endifchanged %}


          <div class="col-12" id="row-{{ a.pk }}">
            <div class="card analysis-card" id="card-{{ a.pk }}">
              <div class="card-body">

                <div class="d-flex align-items-start justify-content-between">
                  <div>
                    <h5 class="mb-1">
                      {% if a.job_title or a.company %}
                        {% if a.job_title %}{{ a.job_title }}{% else %}<span class="text-muted">Untitled role</span>{% endif %}
                        {% if a.company %}<span class="text-muted"> @ {{ a.company }}</span>{% endif %}
                      {% else %}
                        <span class="text-muted">CV vs JD comparison</span>
                      {% endif %}
                    </h5>
                    <div class="small text-muted" title="{{ a.created_at|date:'Y-m-d H:i' }}">
                      Analyzed {{ a.created_at|timesince }} ago
                    </div>
                  </div>


                  <div class="text-end">
                    <div class="match-ring" data-percent="{{ a.match_percent }}">
                      <span class="ring-label">{{ a.match_percent|floatformat:0 }}%</span>
                    </div>
                  </div>

                </div>


                <div class="d-flex justify-content-between align-items-center flex-wrap mt-3">
                  <div class="d-flex gap-2 flex-wrap">
                    {% if a.cv_file %}
                      <a href="{{ a.cv_file.url }}" class="btn btn-clear btn-action btn-sm">Download CV</a>
                    {% else %}
                      <a href="{% url 'analysis_detail' a.pk %}?tab=cv" class="btn btn-clear btn-action btn-sm">View CV Input</a>
                    {% endif %}

                    {% if a.jd_file %}
                      <a href="{{ a.jd_file.url }}" class="btn btn-clear btn-action btn-sm">Download JD</a>
                    {% else %}
                      <a href="{% url 'analysis_detail' a.pk %}?tab=jd" class="btn btn-clear btn-action btn-sm">View JD Input</a>
                    {% endif %}
                  </div>

                  <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'analysis_detail' a.pk %}" class="btn btn-clear btn-action btn-sm">View Results</a>

                    <form method="POST"
                          action="{% url 'analysis_delete' a.pk %}"
                          hx-post="{% url 'analysis_delete' a.pk %}"
                          hx-target="#row-{{ a.pk }}"
                          hx-swap="outerHTML"
                          hx-confirm="Are you sure you want to delete this analysis?"
                          class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-clear btn-action btn-sm">Delete</button>
                    </form>
                  </div>
                </div>

              </div>
            </div>
          </div>

        {% endfor %}
      </div>

    </div>
  {% else %}
    <div class="alert alert-info text-center">You have not uploaded any analyses yet.</div>
  {% endif %}

</div>


<script>
(function(){
  function drawRing(el, pct) {
    const size = 64, segs = 10, gapDeg = 4, thick = 8;
    let c = el.querySelector('canvas');
    if (!c) { c = document.createElement('canvas'); c.width = c.height = size; el.appendChild(c); }
    const ctx = c.getContext('2d');
    ctx.clearRect(0, 0, size, size);

    const cx = size/2, cy = size/2, rOuter = size/2 - 4, rInner = rOuter - thick;
    const fullCircle = Math.PI * 2;
    const segStep = fullCircle / segs;
    const gap = gapDeg * Math.PI/180;
    const segSpan = segStep - gap;
    const startBase = -Math.PI/2;
    const blues = ['#ADD8FF','#8CC8FF','#64B4FA','#50A0F0','#3C8CE6','#3278DC','#2866D2','#1E5CC8','#1450BE','#0A46B4'];

    function wedge(sa, ea, fill) {
      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, sa, ea, false);
      ctx.arc(cx, cy, rInner, ea, sa, true);
      ctx.closePath();
      ctx.fillStyle = fill;
      ctx.fill();
    }


    for (let i=0;i<segs;i++){
      const sa = startBase + i*segStep;
      wedge(sa, sa + segSpan, 'rgba(235,238,241,1)');
    }

    const p = Number(pct ?? 0);
    const clamped = Math.min(100, Math.max(0, p));
    const total = Math.min(segSpan * segs, (clamped / 100) * (segSpan * segs));

    let filled = 0;
    for (let i=0;i<segs && filled < total;i++){
      const segStart = startBase + i*segStep;
      const remaining = total - filled;
      const fillThis = Math.min(segSpan, remaining);
      if (fillThis > 0){
        wedge(segStart, segStart + fillThis, blues[i]);
        filled += fillThis;
      }
    }
  }

  function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

  function animateRing(el, targetPct, duration=700){
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      drawRing(el, targetPct);
      return;
    }
    const start = performance.now();
    function frame(now){
      const t = Math.min(1, (now - start) / duration);
      const current = easeOut(t) * targetPct;
      drawRing(el, current);
      if (t < 1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  document.querySelectorAll('.match-ring').forEach(el=>{
    const target = Math.min(100, Math.max(0, Number(el.dataset.percent ?? 0)));
    drawRing(el, 0);
    animateRing(el, target);
  });
})();
</script>

{% endblock %}
